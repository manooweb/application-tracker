name: Deploy to o2s (job + job-api)

on:
  push:
    branches: [main]
concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    environment: prod
    runs-on: self-hosted

    env:
      FRONT_PATH: ${{ secrets.O2S_FRONT_PATH }}
      BACK_PATH: ${{ secrets.O2S_BACK_PATH }}
      ANGULAR_DIST_DIR: frontend/dist
      RSYNC_RSH: "ssh -o BatchMode=yes"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Diagnostics (env + php + composer)
        run: |
          set -euxo pipefail
          whoami
          node -v
          npm -v
          php -v
          composer -V

      - name: Ensure storage and cache directories are writable
        working-directory: backend
        run: |
          mkdir -p storage/framework/cache storage/framework/sessions storage/framework/views bootstrap/cache
          chmod -R ug+rwx storage bootstrap/cache

      # ---------- Build FRONT ----------
      - name: Install & build Angular
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Resolve Angular dist folder (browser-aware)
        id: ngdist
        run: |
          set -euo pipefail
          DIST_ROOT="frontend/dist"
          APP_DIR="$(find "$DIST_ROOT" -mindepth 1 -maxdepth 1 -type d | head -n 1)"
          if [ -z "${APP_DIR:-}" ]; then
            echo "No Angular dist folder found under $DIST_ROOT" >&2
            exit 1
          fi

          if [ -d "$APP_DIR/browser" ]; then
            DEPLOY_DIR="$APP_DIR/browser"
          else
            DEPLOY_DIR="$APP_DIR"
          fi

          echo "dist_dir=$DEPLOY_DIR" >> "$GITHUB_OUTPUT"
          echo "Angular deploy dir: $DEPLOY_DIR"

      # ---------- Build BACK ----------
      - name: Composer install (prod)
        working-directory: backend
        run: |
          composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

      # ---------- Maintenance gate ----------
      - name: Put API in maintenance (artisan down)
        run: |
          ssh gha-o2s "set -e;
            if [ -f ${BACK_PATH}/artisan ]; then
              cd ${BACK_PATH} && php artisan down --render=errors::503 || true
            else
              echo 'No artisan yet on server (first deploy?) -> skipping down'
            fi
          "

      # ---------- Deploy BACK (B2 rsync) ----------
      - name: Deploy backend to o2s (rsync)
        run: |
          rsync -az --delete --delay-updates \
            --no-owner --no-group --no-perms \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='storage/' \
            --exclude='tests/' \
            --exclude='node_modules/' \
            --exclude='.phpunit.result.cache' \
            backend/ gha-o2s:${BACK_PATH}/

      - name: Run migrations
        run: |
          ssh gha-o2s "set -e;
            cd ${BACK_PATH};
            php artisan migrate --force
          "

      # ---------- Deploy FRONT (B2 rsync) ----------
      - name: Deploy frontend dist to o2s (rsync)
        run: |
          rsync -az --delete --delay-updates \
            --no-owner --no-group --no-perms \
            ${{ steps.ngdist.outputs.dist_dir }}/ gha-o2s:${FRONT_PATH}/

      # ---------- End maintenance ----------
      - name: Bring API back up (artisan up)
        run: |
          ssh gha-o2s "set -e;
            if [ -f ${BACK_PATH}/artisan ]; then
              cd ${BACK_PATH} && php artisan up
            fi
          "
